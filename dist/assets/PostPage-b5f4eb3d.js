import{D as K,d as Q,r as M,b as x,e as R,f as c,i as it,A as rt,w as D,l as et,t as Y,g as b,_ as at,u as dt,o as ct,a as lt,c as mt,k as ut,h as G,F as pt,x as wt,j as ft}from"./index-39bb5b9b.js";import{u as H,a as j}from"./useAuth.vue_vue_type_script_lang-154466f4.js";import{g as ot,r as Z,a as tt}from"./index.esm2017-a0d21084.js";import{P as z,_ as N,R as F,b as E,d as L,g as y,a as $,c as J}from"./index.esm2017-1c1d52a4.js";import{_ as vt}from"./useLoadingPage.vue_vue_type_style_index_0_lang-2ea5b231.js";import{a as gt}from"./axios-4a70c6fc.js";import{c as st}from"./useCalculateTime.vue_vue_type_script_lang-ca052a8e.js";import{u as W}from"./useUserDetails.vue_vue_type_script_lang-6cc3b925.js";import{u as yt}from"./useLikeButton-912bc1e8.js";import"./index.esm-06e63244.js";W();function Pt(m){const{app:r}=H(),A=z(r),w=j(),s=N(A,"users");async function g(){w.signedUser.id===void 0||w.signedUser.id===""?(console.log("not signed in"),K.push("/login")):C()}async function C(){try{const t=F(s,E("id","==",`${w.signedUser.id}`)),o=(await L(t)).docs[0].data(),u=F(s,E("id","==",`${m}`)),n=(await L(u)).docs[0].data(),U=[...o.following.theFollowings,m],I=U.length,T=[...n.followers.theFollowers,w.signedUser.id],p=T.length,S=y(A,"users",m),v=y(A,"users",w.signedUser.id);await $(S,{["followers.theFollowers"]:T,["followers.total"]:p,notifications:[...n.notifications,{type:`${w.signedUser.fullName} started following you`,details:{followerId:w.signedUser.id,time:new Date}}]}),await $(v,{["following.theFollowings"]:U,["following.total"]:I,activityLog:[...o.activityLog,{type:"New following",details:{followingId:m,time:new Date}}]})}catch(t){console.error(t)}}g()}function ht(m,r){W();const{app:A}=H(),w=z(A),s=j(),g=N(w,"users");C();async function C(){try{const t=F(g,E("id","==",`${s.signedUser.id}`)),o=(await L(t)).docs[0].data(),u=F(g,E("id","==",`${m}`)),n=(await L(u)).docs[0].data(),U=o.following.theFollowings.filter(e=>e!==m),I=U.length,T=n.followers.theFollowers.filter(e=>e!==s.signedUser.id),p=T.length,S=y(w,"users",m),v=y(w,"users",s.signedUser.id);await $(S,{["followers.theFollowers"]:T,["followers.total"]:p}),await $(v,{["following.theFollowings"]:U,["following.total"]:I,activityLog:[...o.activityLog,{type:`You unfollowed ${r}`,details:{followingId:m,time:new Date}}]})}catch(t){console.error(t)}}}const nt=j();W();async function Ct(m,r){const{app:A}=H(),w=z(A),s=N(w,"users");if(nt.signedUser.id===void 0||nt.signedUser.id==="")return console.log("not signed in"),!1;return await g();async function g(){try{const C=F(s,E("id","==",`${r}`)),t=F(s,E("id","==",`${m}`)),i=await L(C),o=await L(t),u=i.docs[0].data();return o.docs[0].data().followers.theFollowers.includes(r)&&u.following.theFollowings.includes(m)}catch{return console.log(r,m),!1}}}const Ut=Q({__name:"useAddComment",props:{currentUserId:String,viewPostId:String,viewPostPosterId:String},setup(m){const r=m,{app:A}=H(),w=j(),s=z(A),g=M("");async function C(){const i=y(s,"posts",r.viewPostId);await J(i).then(o=>{w.viwedPost=o.data()}).catch(o=>{console.log(o)})}async function t(i,o,u,P){if(i===""||i===void 0)return K.push("/login");if(P.trim()==="")console.log("comment cannot be empty");else{document.getElementById("btnAddcomment").setAttribute("disabled","true");const n=F(N(s,"users"),E("id","==",`${i}`)),h=F(N(s,"posts"),E("postId","==",`${o}`)),U=F(N(s,"users"),E("id","==",`${u}`));try{L(n).then(I=>{const f=I.docs[0].data();L(h).then(T=>{const p=T.docs[0].data();L(U).then(S=>{const v=S.docs[0].data(),e={commentId:p.postComments.count,details:P,time:new Date};function k(l){return f.comments.out.map(d=>{if(d.postId===o)return{...d,commentArr:[...d.commentArr,l]}})}function a(l){return v.comments.in.map(d=>{if(d.postId===o)return{...d,commentArr:[...d.commentArr,l]}})}f.comments.out.some(l=>l.postId===o)?$(y(s,"users",`${i}`),{["comments.out"]:k(e),["comments.total.out"]:f.comments.total.out+1,activityLog:[...f.activityLog,{type:"You added another comment on this post",details:{commentId:p.postComments.count,postId:o,text:e.details,time:e.time}}],interactions:[...f.interactions,{type:"Commented on this post",details:{commentId:p.postComments.count,postid:o,text:e.details,time:e.time}}]}):$(y(s,"users",`${i}`),{["comments.out"]:[...f.comments.out,{postId:o,commentArr:[e]}],["comments.total.out"]:f.comments.total.out+1,activityLog:[...f.activityLog,{type:"You commented on this post",details:{commentId:p.postComments.count,postId:o,text:e.details,time:e.time}}],interactions:[...f.interactions,{type:"Commented on this post",details:{commentId:p.postComments.count,postid:o,text:e.details,time:e.time}}]}),p.postComments&&$(y(s,"posts",`${o}`),{["postComments.details"]:[...p.postComments.details,{commentId:p.postComments.count,id:i,text:e.details,time:e.time}],["postComments.total"]:p.postComments.total+1,["postComments.count"]:p.postComments.count+1}),v.comments.in.some(l=>l.postId===o)?$(y(s,"users",`${u}`),{["comments.in"]:a(e),["comments.total.in"]:v.comments.total.in+1,notifications:[...v.notifications,{type:`Your got a comment from <b>${f.fullName}</b> on a post`,details:{commentId:p.postComments.count,postid:o,text:e.details,time:e.time}}]}):$(y(s,"users",`${u}`),{["comments.in"]:[...v.comments.in,{postId:o,commentArr:[e]}],["comments.total.in"]:v.comments.total.in+1,notifications:[...v.notifications,{type:`Your got a comment from <b>${f.fullName}</b> on a post`,details:{commentId:p.postComments.count,postid:o,text:e.details,time:e.time}}]}),g.value="",document.getElementById("btnAddcomment").removeAttribute("disabled"),C()})})})}catch(I){console.log(I),document.getElementById("btnAddcomment").removeAttribute("disabled")}}}return(i,o)=>(x(),R("div",null,[c("div",null,[it(c("textarea",{"onUpdate:modelValue":o[0]||(o[0]=u=>g.value=u)},null,512),[[rt,g.value]]),c("button",{onClick:o[1]||(o[1]=D(u=>t(r.currentUserId,r.viewPostId,r.viewPostPosterId,g.value),["prevent"])),id:"btnAddcomment"},[et("Add the "),c("span",null,Y(b(w).viwedPost.postComments.total+1),1),et(" Comment")])])]))}}),It=Q({__name:"useDeleteComment",props:{currentUserId:String,viewPostId:String,viewPostPosterId:String,commentId:Number,commentText:String},setup(m){const r=m,{app:A}=H(),w=j(),s=z(A);async function g(){const t=y(s,"posts",r.viewPostId);await J(t).then(i=>{w.viwedPost=i.data()}).catch(i=>{console.log(i)})}async function C(t,i,o,u,P){if(t===""||t===void 0)return K.push("/login");{const n=F(N(s,"users"),E("id","==",`${t}`)),h=F(N(s,"posts"),E("postId","==",`${i}`)),U=F(N(s,"users"),E("id","==",`${o}`));try{L(n).then(I=>{const f=I.docs[0].data();L(h).then(T=>{const p=T.docs[0].data();L(U).then(S=>{const v=S.docs[0].data();function e(a){return a.comments.out.map(d=>{if(d.postId===i)if(d.commentArr.length>1){const V=d.commentArr.filter(_=>_.commentId!==u);return{...d,commentArr:V}}else return null;return d}).filter(d=>d!==null)}function k(a){return a.comments.in.map(d=>{if(d.postId===i)if(d.commentArr.length>1){const V=d.commentArr.filter(_=>_.commentId!==u);return{...d,commentArr:V}}else return null;return d}).filter(d=>d!==null)}f.comments.out.some(a=>a.postId===i)&&$(y(s,"users",`${t}`),{["comments.out"]:e(f),["comments.total.out"]:f.comments.total.out-1,activityLog:[...f.activityLog,{type:"You deleted a comment on this post",details:{commentId:u,postId:i,text:P,time:new Date}}],interactions:f.interactions.filter(a=>a.details.commentId!==u)}),p.postComments&&$(y(s,"posts",`${i}`),{["postComments.details"]:p.postComments.details.filter(a=>a.commentId!==u),["postComments.total"]:p.postComments.total-1}),v.comments.in.some(a=>a.postId===i)&&$(y(s,"users",`${o}`),{["comments.in"]:k(v),["comments.total.in"]:v.comments.total.in-1,notifications:v.notifications.filter(a=>a.details.commentId!==u)}),g()})})})}catch(I){console.log(I)}}}return(t,i)=>(x(),R("button",{onClick:i[0]||(i[0]=D(o=>C(r.currentUserId,r.viewPostId,r.viewPostPosterId,m.commentId,m.commentText),["prevent"]))},"Delete"))}}),At={key:1,id:"editContainer"},_t={id:"centerContainer"},bt=["onClick"],$t=Q({__name:"useEditComment",props:{currentUserId:String,viewPostId:String,viewPostPosterId:String,commentId:Number,commentText:String,divEditId:String},setup(m){const r=m,{app:A}=H(),w=j(),s=z(A),g=M(""),C=M(!1);async function t(){const P=y(s,"posts",r.viewPostId);await J(P).then(n=>{w.viwedPost=n.data()}).catch(n=>{console.log(n)})}async function i(P,n,h,U,I){if(P===""||P===void 0)return K.push("/login");if(U.trim()==="")console.log("Comment cannot be empty");else{document.getElementById("btnEditComment").setAttribute("disabled","true");const f=F(N(s,"users"),E("id","==",`${P}`)),T=F(N(s,"posts"),E("postId","==",`${n}`)),p=F(N(s,"users"),E("id","==",`${h}`));try{L(f).then(S=>{const v=S.docs[0].data();L(T).then(e=>{const k=e.docs[0].data();L(p).then(a=>{const l=a.docs[0].data();function q(){return v.comments.out.map(B=>{if(B.postId===n){const X=B.commentArr.map(O=>O.commentId===I?{...O,details:U}:O);return{...B,commentArr:X}}return B})}function d(){return l.comments.in.map(B=>{if(B.postId===n){const X=B.commentArr.map(O=>O.commentId===I?{...O,details:U}:O);return{...B,commentArr:X}}return B})}function V(){return k.postComments.details.map(B=>B.commentId===I?{...B,text:U}:B)}v.comments.out.some(_=>_.postId===n)&&$(y(s,"users",`${P}`),{["comments.out"]:q(),activityLog:[...v.activityLog,{type:"You edited your comment on this post",details:{commentId:k.postComments.count,postId:n,text:U,time:new Date}}]}),k.postComments&&$(y(s,"posts",`${n}`),{["postComments.details"]:V()}),l.comments.in.some(_=>_.postId===n)&&$(y(s,"users",`${h}`),{["comments.in"]:d()}),document.getElementById("btnEditComment").removeAttribute("disabled"),t(),C.value=!1})})})}catch(S){console.log(S),document.getElementById("btnEditComment").removeAttribute("disabled")}}}function o(P){const n=document.getElementById(`${P}`);g.value=n.innerText,C.value=!0}function u(){document.getElementById("btnEditComment").setAttribute("disabled","true"),g.value="",C.value=!1}return(P,n)=>C.value?(x(),R("div",At,[c("div",_t,[it(c("textarea",{"onUpdate:modelValue":n[1]||(n[1]=h=>g.value=h)},null,512),[[rt,g.value]]),c("button",{id:"btnEditComment",onClick:n[2]||(n[2]=D(h=>i(r.currentUserId,r.viewPostId,r.viewPostPosterId,g.value,m.commentId),["prevent"]))},"Update"),c("button",{onClick:D(u,["prevent"])},"Cancel",8,bt)])])):(x(),R("button",{key:0,onClick:n[0]||(n[0]=D(h=>o(r.divEditId),["prevent"]))},"Edit"))}});const kt=at($t,[["__scopeId","data-v-5b33aa43"]]),xt={key:1},Ft={key:0},Et=["src"],Lt={key:0},Rt=["onClick"],Tt=["onClick"],St=["innerHTML"],qt={key:0},Bt={key:1},Nt=["id"],Mt={key:1},Vt=c("h1",null,"Post not found or Deleted",-1),Ot=c("button",null,"Expore Chatter",-1),Yt=c("button",null,"Home",-1),Zt=Q({__name:"PostPage",props:["postId"],setup(m){const r=m;W();const A=M(!0),w=M(""),s=M([]),{app:g}=H(),C=z(g),t=j(),i=dt(),o=ot(g),u=y(C,"posts",r.postId),P=new DOMParser,n=M([]),h=M(!1);async function U(){try{await Promise.all(t.viwedPost.postMedia.map(async e=>{const k=Z(o,e.mediaFullPath),a=await tt(k);s.value.push(a)})).catch(()=>{console.log("error")})}catch(e){console.log(e)}}async function I(){try{const e=await J(u);e.data()!==void 0&&(t.viwedPost=e.data(),U(),f(),T(),$(u,{postViews:t.viwedPost.postViews+1}))}catch{i.push("/error")}}I();async function f(){try{const e=Z(o,t.viwedPost.postContain),k=await tt(e).catch(a=>{console.log(a)});await gt.post("/postContent",{contentUrl:k}).then(a=>{const l=P.parseFromString(a.data,"text/html");l.body.querySelectorAll("img, video").forEach((q,d)=>{q.setAttribute("src",`${s.value[d]}`)}),w.value=l.body.innerHTML}).catch(a=>{console.log(a)})}catch(e){console.log(e)}}async function T(){try{const e=y(C,"users",t.viwedPost.posterId),k=await J(e);if(k.data()!==void 0){const{fullName:a,profilePicture:l}=k.data(),q={fullName:a,profilePicture:l,id:v},d=ot(),V=Z(d,"ChatterAppFiles/avatar/unknown/UnkownUser.png");n.value.push(q),await Ct(t.viwedPost.posterId,t.signedUser.id).then(_=>{h.value=_});try{await tt(V).then(_=>{n.value[0].profilePicture===""&&(n.value[0].profilePicture=_)})}catch(_){console.log(_)}}}catch{}}async function p(){ht(t.viwedPost.posterId,n.value[0].fullName),h.value=!h.value}async function S(){Pt(t.viwedPost.posterId),h.value=!h.value}let v=setTimeout(()=>{A.value=!1},5e3);return ct(()=>{clearTimeout(v)}),(e,k)=>{const a=lt("RouterLink");return A.value?(x(),mt(vt,{key:0,"action-name":"Loading Post..."})):(x(),R("main",xt,[b(t).viwedPost.posterId!==void 0?(x(),R("div",Ft,[c("h1",null,Y(b(t).viwedPost.postTitle.join(" ")),1),c("div",null,[c("div",null,[c("img",{src:n.value[0].profilePicture,width:"50",height:"50"},null,8,Et),c("h3",null,Y(n.value[0].fullName),1),b(t).signedUser.id!==b(t).viwedPost.posterId?(x(),R("div",Lt,[h.value?(x(),R("button",{key:0,onClick:D(p,["prevent"])},"UnFollow",8,Rt)):(x(),R("button",{key:1,onClick:D(S,["prevent"])},"Follow",8,Tt))])):ut("",!0)])]),c("div",null,Y(st(b(t).viwedPost.postTime.seconds)),1),c("div",{innerHTML:w.value},null,8,St),c("div",null,[G(yt,{currentUserId:b(t).signedUser.id,viewPostId:r.postId,viewPostPosterId:b(t).viwedPost.posterId},null,8,["currentUserId","viewPostId","viewPostPosterId"])]),c("div",null,[c("div",null,[b(t).viwedPost.postComments.total<1?(x(),R("p",qt,"No comments yet")):(x(),R("div",Bt,[(x(!0),R(pt,null,wt(b(t).viwedPost.postComments.details,(l,q)=>(x(),R("div",{key:q},[c("p",null,"postId: "+Y(l.id),1),c("div",{id:q.toString()+"commentDiv"},Y(l.text),9,Nt),c("p",null,"Time: "+Y(st(l.time.seconds)),1),c("div",null,[G(It,{currentUserId:b(t).signedUser.id,viewPostId:r.postId,viewPostPosterId:b(t).viwedPost.posterId,commentId:l.commentId,commentText:l.text},null,8,["currentUserId","viewPostId","viewPostPosterId","commentId","commentText"]),G(kt,{currentUserId:b(t).signedUser.id,viewPostId:r.postId,viewPostPosterId:b(t).viwedPost.posterId,commentId:l.commentId,commentText:l.text,divEditId:q.toString()+"commentDiv"},null,8,["currentUserId","viewPostId","viewPostPosterId","commentId","commentText","divEditId"])])]))),128))]))]),G(Ut,{currentUserId:b(t).signedUser.id,viewPostId:r.postId,viewPostPosterId:b(t).viwedPost.posterId},null,8,["currentUserId","viewPostId","viewPostPosterId"])])])):(x(),R("div",Mt,[Vt,c("div",null,[Ot,G(a,{to:"/"},{default:ft(()=>[Yt]),_:1})])]))]))}}});export{Zt as default};
